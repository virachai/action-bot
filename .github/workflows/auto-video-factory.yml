name: Auto Video Factory

on:
  # Run hourly
  schedule:
    - cron: '0 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      topic:
        description: 'Video topic'
        required: false
        default: 'Trending Tech News'

jobs:
  generate-video:
    name: Generate Short Video
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Install Python dependencies (AI Logic)
        working-directory: apps/ai-logic
        run: pip install -r requirements.txt
      
      - name: Install Python dependencies (Video Engine)
        working-directory: apps/video-engine
        run: pip install -r requirements.txt
      
      - name: Build packages
        run: pnpm run build
      
      - name: Start AI Logic Service
        working-directory: apps/ai-logic
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-1.5-flash
        run: |
          uvicorn src.main:app --host 0.0.0.0 --port 8001 &
          echo $! > ai-logic.pid
          sleep 5
      
      - name: Start Video Engine Service
        working-directory: apps/video-engine
        env:
          VIDEO_WIDTH: 1080
          VIDEO_HEIGHT: 1920
          VIDEO_FPS: 30
        run: |
          uvicorn src.main:app --host 0.0.0.0 --port 8002 &
          echo $! > video-engine.pid
          sleep 5
      
      - name: Run Orchestrator
        working-directory: apps/orchestrator
        env:
          # Gemini Configuration
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-1.5-flash
          
          # AWS S3 Configuration
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          S3_BUCKET_INPUT: ${{ secrets.S3_BUCKET_INPUT || 'auto-short-factory-input' }}
          S3_BUCKET_OUTPUT: ${{ secrets.S3_BUCKET_OUTPUT || 'auto-short-factory-output' }}
          S3_BUCKET_ASSETS: ${{ secrets.S3_BUCKET_ASSETS || 'auto-short-factory-assets' }}
          
          # Video Configuration
          VIDEO_TOPIC: ${{ github.event.inputs.topic || secrets.VIDEO_TOPIC || 'AI and Technology Trends' }}
          VIDEO_WIDTH: 1080
          VIDEO_HEIGHT: 1920
          VIDEO_FPS: 30
          
          # Service URLs
          AI_LOGIC_URL: http://localhost:8001
          VIDEO_ENGINE_URL: http://localhost:8002
          
          # Environment
          NODE_ENV: production
        run: |
          pnpm run start
      
      - name: Upload video artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-video-${{ github.run_number }}
          path: apps/orchestrator/output/**/*.mp4
          retention-days: 7
      
      - name: Upload script artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-script-${{ github.run_number }}
          path: apps/orchestrator/output/**/*.json
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: |
          if [ -f apps/ai-logic/ai-logic.pid ]; then
            kill $(cat apps/ai-logic/ai-logic.pid) || true
          fi
          if [ -f apps/video-engine/video-engine.pid ]; then
            kill $(cat apps/video-engine/video-engine.pid) || true
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Video generation failed!"
          echo "Check the logs for details."
